---
name: GitHub CI for 1.0.2

on: [pull_request, push]

jobs:
  # This checks that we use ANSI C language syntax and semantics.
  # We are not as strict with libraries, but rather adapt to what's
  # expected to be available in a certain version of each platform.
  check-ansi:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: config
      run: CPPFLAGS=-ansi ./config no-asm --strict-warnings
    - name: make
      run: make -s
    - name: make test
      run: make test

  basic_gcc:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: config
      run: CC=gcc ./config --strict-warnings
    - name: make
      run: make -s
    - name: make test
      run: make test

  basic_clang:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: config
      run: CC=clang ./config
    - name: make
      run: make -s
    - name: make test
      run: make test

  minimal:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: config
      run: ./config --strict-warnings shared no-dso enable-bf no-camellia no-cast no-cmac enable-cms enable-comp enable-des enable-dh enable-dsa no-dtls no-ec2m enable-engine no-gost no-idea no-mdc2 no-md4 no-multiblock no-nextprotoneg enable-ocsp no-psk enable-rc2 enable-rc4 no-rmd160 enable-seed no-srp no-srtp no-ssl3 no-ssl3-method no-whirlpool no-asm -DOPENSSL_SMALL_FOOTPRINT && make depend
    - name: make
      run: make # verbose, so no -s here
    - name: make test
      run: make test

  shared:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: config
      run: ./config --strict-warnings shared
    - name: make
      run: make -s
    - name: make test
      run: make test

  address_sanitizer:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: config
      run: ./config --debug -fsanitize=address -fno-omit-frame-pointer enable-rc5 enable-md2 enable-ec_nistp_64_gcc_128 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION && make depend
    - name: make
      run: make -s
    - name: make test
      run: make test

  enable_non-default_options:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: config
      run: ./config --strict-warnings enable-ec enable-ssl-trace enable-zlib enable-zlib-dynamic enable-crypto-mdebug enable-crypto-mdebug-backtrace enable-egd && make depend
    - name: make
      run: make -s
    - name: make test
      run: make test
